<!DOCTYPE html>
<html>
<head>
    <title>Peta Persebaran Sekolah di Kota Bandung - GeoLabUPI</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.0/dist/leaflet-search.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geojson@1.0.0/dist/leaflet-control-geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geojson@1.0.0/dist/leaflet-control-geojson.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@1.0.0/dist/leaflet-control-geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="style.css" />
</head>
<body class="flex flex-col min-h-screen" x-data="{ open: false }">
    <header class="bg-white shadow p-4 flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-800">Persebaran Sekolah di Kota Bandung</h1>
        <!-- Tambahkan "GeoLab UPI di sisi kanan heading" -->
         <h1 class="text-xl font-bold text-gray-800">GeoLab UPI</h1>
        <utton class="md:hidden text-gray-800 toggle-btn" @click="open = !open" :class="{ 'active': open }">
            <svg class="w-6 h-6 transition-transform duration-300 ease-in-out" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
            </svg>
        </button>
    </header>
    
    <div class="flex flex-1" x-data="petaSekolah" x-init="initMap()">
        <div class="bg-gray-800 text-white w-64 p-4 md:block" :class="{ 'hidden': !open }">
            <div>
                <h2 class="text-lg font-semibold mb-2">Pencarian Sekolah</h2>
                <p class="text-sm text-gray-400 mb-4">Gunakan pencarian untuk menemukan sekolah tertentu.</p>
                <div class="mb-4 relative">
                    <input x-model="kategori" 
                           class="w-full p-2 rounded bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500" 
                           placeholder="Cari nama sekolah..." type="text">
                    
                    <ul x-show="filteredSekolah().length > 0" 
                        class="absolute z-10 bg-white text-black border border-gray-200 w-full mt-1 max-h-60 overflow-y-auto rounded shadow">
                        <template x-for="item in filteredSekolah()" :key="item.properties.Nama">
                            <li @click="zoomTo(item); kategori=item.properties.Nama;" 
                                class="px-3 py-2 hover:bg-blue-100 cursor-pointer"
                                x-text="item.properties.Nama"></li>
                        </template>
                    </ul>
                </div>
                
                <button @click="locateUser()" 
                        class="mt-4 mb-4 bg-blue-500 text-white p-2 rounded w-full flex justify-center items-center hover:bg-blue-600 transition-colors">
                    
                    <svg x-show="loadingLocation" class="animate-spin h-5 w-5 mr-2 text-white" 
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" 
                            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                    </svg>
                    
                    <span x-text="loadingLocation ? 'Mencari lokasi...' : 'Temukan Lokasi Saya'"></span>
                </button>

                <hr class="border-gray-600 mb-4">

                <div>
                    <h2 class="text-md font-semibold mb-2">Input Manual Sekolah</h2>
                    <button @click="startAddSchool()" 
                        class="w-full bg-blue-600 text-white p-2 text-xs rounded hover:bg-blue-700 mb-2">
                        âž• Tambah Sekolah
                    </button>

                    <button @click="exportSchoolsToExcel()" 
                        class="w-full bg-green-600 text-white p-2 text-xs rounded hover:bg-green-700 mb-4">
                        ðŸ“¤ Unduh Excel
                    </button>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">Kategori Sekolah</h3>
                    <template x-for="(val, key) in layers" :key="key">
                        <label class="flex items-center mb-2 transition-colors hover:bg-gray-700 rounded cursor-pointer">
                            <input type="checkbox" :value="key" x-model="layers[key]" @change="updateMap()" class="mr-2">
                            <span class="w-4 h-4 inline-block mr-2 rounded-full" 
                                  :class="{
                                    'bg-blue-500': key === 'sd',
                                    'bg-green-500': key === 'smp',
                                    'bg-yellow-500': key === 'sma',
                                    'bg-purple-500': key === 'man',
                                    'bg-red-500': key === 'mas',
                                    'bg-yellow-300': key === 'mi',
                                    'bg-indigo-500': key === 'mts'
                                  }"></span>
                            <span x-text="key.toUpperCase()"></span>
                        </label>
                    </template>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">Tipe Peta Dasar</h3>
                    <template x-for="(layer, key) in { 'ESRI World Imagery': true, 'Google Satellite': true, 'OpenStreetMap': true}" :key="key">
                        <label class="flex items-center mb-2 transition-colors hover:bg-gray-700 rounded cursor-pointer">
                            <input type="radio" name="basemap" :value="key" @change="
                                Object.keys(map._layers).forEach(lid => {
                                    let lyr = map._layers[lid];
                                    if (lyr.options && lyr.options.attribution) {
                                        map.removeLayer(lyr);
                                    }
                                });
                                if (key === 'ESRI World Imagery') {
                                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                                        attribution: 'Tiles &copy; Esri'
                                    }).addTo(map);
                                } else if (key === 'Google Satellite') {
                                    L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                                        attribution: '&copy; Google'
                                    }).addTo(map);
                                } else if (key === 'OpenStreetMap') {
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{y}/{png}', {
                                        attribution: '&copy; OpenStreetMap'
                                    }).addTo(map);
                                } 
                            " class="mr-2">
                            <span class="inline-block"
                                  :class="{
                                    key === 'ESRI World Imagery',
                                    key === 'Google Satellite'
                                  }"></span>
                            <span x-text="key"></span>
                        </label>
                    </template>
                </div>

                <hr class="border-gray-600 mb-4">

                <!-- Simpan Hasil Digitasi -->
                <!-- <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">Simpan Hasil Digitasi</h3>
                    <p class="text-sm text-gray-400 mb-2">Pilih format file untuk menyimpan hasil digitasi.</p>
                    <select x-model="exportFormat" class="w-full p-2 rounded bg-gray-700 text-white hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                        <option value="geojson">GeoJSON</option>
                        <option value="kml">KML</option>
                        <option value="shp">Shapefile</option>
                        <option value="screenshot">Screenshot</option>
                    </select>
                    <button @click="saveDigitasi()" class="mt-2 bg-green-500 text-white p-2 rounded w-full hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">Simpan</button>
                </div> -->
            </div>
        </div>
        
        <div id="map" class="flex-1"></div>

        <div class="bg-gray-800 text-white w-64 p-4 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Panel Analisis SIG</h2>
            </div>
            <hr class="border-gray-600 mb-4">

            <div>
                <h3 class="text-sm font-semibold mb-2">Zoom Muka Peta</h3>
                <input type="range" min="10" max="500" step="10"
                    x-model="mapZoomPercent" @input="applyMapZoom()"
                    class="w-full accent-green-500">
                <p class="text-xs text-gray-400 mt-1 text-center" x-text="mapZoomPercent + '%'"></p>
            </div>

            <hr class="border-gray-600 mb-2">

            <!-- Analisis Buffer -->
            <div x-show="!isBuffering">
                <h3 class="text-sm font-semibold mb-2">Analisis Radius Titik Sekolah</h3>
                <button @click="startBufferMode()" class="w-full bg-blue-500 text-white p-2 rounded flex justify-center items-center hover:bg-blue-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                    <span>Analisis Buffer</span>
                </button>
            </div>

            <div x-show="isBuffering">
                <p class="text-sm text-yellow-400 mb-2">Silakan klik satu titik sekolah di peta...</p>
                <button @click="cancelBufferMode()" class="w-full bg-gray-500 text-white p-2 text-xs rounded hover:bg-gray-600">Batalkan</button>
            </div>

            <div x-show="isBufferVisible">
                <h3 class="text-sm font-semibold mt-2">Kontrol Hasil Analisis Buffer</h3>
                <button @click="clearBufferAnalysis()" class="w-full bg-red-500 text-white p-2 rounded flex justify-center items-center hover:bg-red-600 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                     <span>Hapus Hasil Analisis</span>
                </button>
            </div>

            <div x-show="!isBufferVisible">
                <p class="text-sm text-gray-400 mt-2">Belum ada hasil analisis.</p>
            </div>
            
            <hr class="border-gray-600 my-2">

            <!-- Network Analysis (Route Analysis) -->
            <div x-show="!isRouting">
                <h3 class="text-sm font-semibold mb-2">Analisis Rute ke Sekolah</h3>
                <button @click="startRoutingMode()" class="w-full bg-blue-500 text-white p-2 rounded flex justify-center items-center hover:bg-blue-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                    <span>Analisis Rute</span>
                </button>
            </div>

            <div x-show="isRouting">
                <p class="text-sm text-yellow-400 mb-2">Silakan klik satu titik sekolah di peta...</p>
                <button @click="cancelRoutingMode()" class="w-full bg-gray-500 text-white p-2 text-xs rounded hover:bg-gray-600">Batalkan</button>
            </div>
            
            <div x-show="isRouteVisible">
                <h3 class="text-sm font-semibold mt-2">Kontrol Hasil Analisis Routing</h3>
                <button @click="clearRoutingAnalysis()" class="w-full bg-red-500 text-white p-2 rounded flex justify-center items-center hover:bg-red-600 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                     <span>Hapus Hasil Analisis</span>
                </button>
            </div>

            <div x-show="!isRouteVisible">
                <p class="text-sm text-gray-400 mt-2">Belum ada hasil analisis.</p>
            </div>
            
            <hr class="border-gray-600 my-4">

            <div class="mb-2">
                <label class="text-sm font-semibold block mb-1">Judul Peta</label>
                <input type="text" x-model="layoutTitle"
                    class="w-full p-2 rounded bg-gray-700 text-white placeholder-gray-400 text-sm"
                    placeholder="Contoh: Peta Persebaran Sekolah">
            </div>

            <div class="mb-4">
                <label class="text-sm font-semibold block mb-1">Nama Layer Digitasi</label>
                <input type="text" x-model="digitasiLayerName"
                    class="w-full p-2 rounded bg-gray-700 text-white placeholder-gray-400 text-sm"
                    placeholder="Contoh: Lokasi Rencana Sekolah">
            </div>

            <div class="flex gap-2">
                <button @click="saveLayoutInput()"
                    class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-sm">
                    Simpan Input
                </button>

                <button @click="openMapLayout()"
                    class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600 text-sm">
                    Buka Layout Peta
                </button>
            </div>

        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script> <!-- Leaflet.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script> <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script> <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <!-- SheetJS -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script> <!-- Leaflet Draw -->
    <script src="https://unpkg.com/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.js"></script> <!-- Leaflet Locate Control -->
    <script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script> <!-- toGeoJSON for KML conversion -->
    <script src="https://unpkg.com/shp-write@0.3.2/shpwrite.js"></script> <!-- shp-write for Shapefile export -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script> <!-- Turf.js for geospatial operations -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script> <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script> <!-- html-to-image for screenshot -->
    <script src="script.js"></script>
</body>
</html>